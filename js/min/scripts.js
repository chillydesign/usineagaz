function loadEventSlider(){$(".event_slider").bxSlider({auto:!0,controls:!0,autoHover:!0,video:!0,pager:!1,mode:"fade"})}function getAccessToken(){hasLocalStorage()&&(localStorage.removeItem("usine_access_token"),localStorage.removeItem("usine_events")),$.ajax({url:access_token_url,method:"GET",data:{}}).done(function(e){if(e.error)console.log(error.error_description);else{var t=e.access_token;hasLocalStorage()&&localStorage.setItem("usine_access_token",t),callEventsApi(t)}})}function shouldGetEventsFromStorage(){if(hasLocalStorage()){var e=localStorage.getItem("usine_events"),t=localStorage.getItem("usine_events_time");return null!=e&&((new Date).getTime()-t)/1e3/60/30<1}return!1}function callEventsApi(e){if(shouldGetEventsFromStorage()){var t=localStorage.getItem("usine_events");initUsineEvents(JSON.parse(t))}else{$.ajax({url:"https://api.intrazik.com/api/v1/programmation",method:"GET",data:{access_token:e,dateTimeDebut:"2017-05-01",dateTimeFin:"2023-12-01"}}).done(function(e){hasLocalStorage()&&(localStorage.setItem("usine_events_time",(new Date).getTime()),localStorage.setItem("usine_events",JSON.stringify(e))),initUsineEvents(e)}).fail(function(e){"invalid_grant"==e.responseJSON.error&&(console.log("invlaidgrant"),getAccessToken())})}}function getEventTypeName(e,t){var n=_.find(t,function(t){return t.eventTypeId==e});return void 0!==n&&n.eventTypeLib.fre}function getMediaFiles(e,t){var t=_.filter(t,function(t){return t.eventId==e}),n={audios:[],visuels:[],embededs:[]};return _.each(t,function(e){void 0!==e.medias.audio&&(audios=e.medias.audio,_.each(audios,function(e){n.audios.push(e.content_url)})),void 0!==e.medias.embeded&&(embededs=e.medias.embeded,_.each(embededs,function(e){n.embededs.push(e.content)})),void 0!==e.medias.visuel&&(visuels=e.medias.visuel,_.each(visuels,function(e){n.visuels.push(e.content_url)}))}),n}function processData(e,t,n){var a=e.events,i=e.event_types,o=e.plays;if(void 0!==t&&t!=={}){var s=Date.parse(t.dateTimeDebut);_.isNaN(s)||(a=_.filter(a,function(e){return Date.parse(e.dateStart)==s}))}void 0!==n&&0!=n&&(a=_.filter(a,function(e){return e.title.fre.toLowerCase().indexOf(n.toLowerCase())>-1||e.description2.fre.toLowerCase().indexOf(n.toLowerCase())>-1}));for(var r=_.toArray(a),l=0;l<r.length;l++){var c=r[l];c.the_title=c.title.fre,c.the_subtitle=c.subtitle.fre,c.the_style=c.style.fre,c.the_description2=c.description2.fre,c.the_link1=c.link1.fre,""==c.the_link1&&(c.the_link1=!1),c.the_month=c.dateStart.split("-")[1],c.the_month_text=numberToMonth(c.the_month),c.the_day=c.dateStart.split("-")[2],c.the_description_short=jQuery("<p>"+c.the_description2+"</p>").text().split(" ").slice(0,50).join(" ")+"...",c.the_category=getEventTypeName(c.eventTypeId,i),c.the_media=getMediaFiles(c.eventId,o),c.the_usine_link=single_event_page+"#e="+c.eventId,c.the_banner="",void 0!==c.medias.visuel&&(c.the_banner=c.medias.visuel[0].content_url)}return e.events=r,e}function get_single_event(e,t){return _.find(e,function(e){return e.eventId==t})}function displaySingleEvent(e,t,n){t.html(n({event:e})),loadEventSlider()}function displayEvents(e,t,n){var a=_.clone(e),i=$(".date_field"),o=$("#eventKeyword"),s={};i.each(function(){var e=$(this);$name=e.attr("name"),""!=e.val()&&(s[$name]=e.val())}),$search=!1,""!=o.val()&&($search=o.val());var r=processData(a,s,$search);t.html(n({events:r.events}))}function numberToMonth(e){return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e-1]}function hasLocalStorage(){var e=window.sessionStorage;try{return e.setItem("test","1"),e.removeItem("test"),!0}catch(e){return!1}}function initUsineEvents(e){var t=$("#events_template").html(),n=$("#events_container"),a=$("#more_events_template").html(),i=$("#more_events_container"),o=$("#event_single_template").html(),s=$("#event_single_container"),r=$(".date_field"),l=$("#eventKeyword"),c=$("#calendar_template").html(),d=$("#calendar_container"),v=processData(e);if(n.length>0){var u=_.template(t);$events_for_prochainement=v.events.slice(0,3),n.html(u({events:$events_for_prochainement}))}if(i.length>0){var h=_.template(a);displayEvents(e,i,h),r.on("change",function(t){displayEvents(e,i,h)}),l.on("keyup",function(t){displayEvents(e,i,h)})}if(d.length>0){d.clndr({template:c,forceSixRows:!0,events:e.events,dateParameter:"dateStart",clickEvents:{click:function(e){var t=e.date._i;$("#dateTimeDebut").val(t).change(),d.removeClass("clndr_visible")}}});$("#dateTimeDebut").on("click",function(){d.toggleClass("clndr_visible")})}if(window.location.hash)for(var m=window.location.hash.split("&"),f=0;f<m.length;f++){var g=m[f];if(-1!==g.indexOf("e=")){var p=g.split("=")[1];if(s.length>0){var S=get_single_event(v.events,p);displaySingleEvent(S,s,_.template(o)),document.title=S.the_title}}}}function jumpToSearchEventsForm(){var e=$("#jump_to_search"),t=$("#eventSearchForm").hide();if(e.on("click",function(e){e.preventDefault();var n=$(this).attr("href"),a=n.split("#")[1];t.show(),void 0!==a&&t.length>0?$("html, body").animate({scrollTop:t.offset().top-100},1e3):window.location.href=n}),window.location.hash)for(var n=window.location.hash.split("&"),a=0;a<n.length;a++)-1!==n[a].indexOf("eventSearchForm")&&(t.show(),$("html, body").animate({scrollTop:t.offset().top-100},1e3))}function resetCalendar(){$("#dateTimeDebut").val("").change(),$("#calendar_container").removeClass("clndr_visible")}!function(e,t,n){e(function(){"use strict";var t=e(window),n=(e("body"),t.height(),e("header")),a=e("#social_bar"),i=e("#featured_section"),o=e("#featured_slides");i.outerHeight();hasLocalStorage()&&null!=localStorage.getItem("usine_access_token")?callEventsApi(localStorage.getItem("usine_access_token")):"undefined "!=typeof access_token_url&&getAccessToken();var s=e("#show_nav"),r=e("header nav");s.on("click",function(e){e.preventDefault(),r.toggleClass("navigation_visible")}),jumpToSearchEventsForm(),setInterval(function(){o.click()},5e3),t.scroll(function(){t.scrollTop()>300?(n.addClass("visible_header"),a.addClass("visible_bar")):(n.removeClass("visible_header"),a.removeClass("visible_bar"))}),e(o).on("click",function(){var t=e("li.visible_slide",o),n=t.next("li");0==n.length&&(n=e("li",o).first()),t.removeClass("visible_slide"),n.addClass("visible_slide")});var l=Math.floor(t.width()/260);e("#partners_slider").bxSlider({minSlides:l,maxSlides:l,slideWidth:260,slideMargin:10,auto:!0,controls:!0,autoControls:!1,pager:!1}),loadEventSlider()})}(jQuery);