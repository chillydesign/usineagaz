function loadEventSlider(){$(".event_slider").bxSlider({auto:!0,controls:!0,autoHover:!0,video:!0,pager:!1})}function getAccessToken(){hasLocalStorage()&&(localStorage.removeItem("usine_access_token"),localStorage.removeItem("usine_events")),$.ajax({url:access_token_url,method:"GET",data:{}}).done(function(e){if(e.error)console.log(error.error_description);else{var t=e.access_token;hasLocalStorage()&&localStorage.setItem("usine_access_token",t),callEventsApi(t)}})}function shouldGetEventsFromStorage(){if(hasLocalStorage()){var e=localStorage.getItem("usine_events"),t=localStorage.getItem("usine_events_time");return null!=e&&((new Date).getTime()-t)/1e3/60/30<1}return!1}function callEventsApi(e){if(shouldGetEventsFromStorage()){var t=localStorage.getItem("usine_events");initUsineEvents(JSON.parse(t))}else{$.ajax({url:"https://api.intrazik.com/api/v1/programmation",method:"GET",data:{access_token:e,dateTimeDebut:"2017-05-01",dateTimeFin:"2019-12-01"}}).done(function(e){hasLocalStorage()&&(localStorage.setItem("usine_events_time",(new Date).getTime()),localStorage.setItem("usine_events",JSON.stringify(e))),initUsineEvents(e)}).fail(function(e){"invalid_grant"==e.responseJSON.error&&(console.log("invlaidgrant"),getAccessToken())})}}function getEventTypeName(e,t){var n=_.find(t,function(t){return t.eventTypeId==e});return void 0!==n&&n.eventTypeLib.fre}function getMediaFiles(e,t){var t=_.filter(t,function(t){return t.eventId==e}),n={audios:[],visuels:[],embededs:[]};return _.each(t,function(e){void 0!==e.medias.audio&&(audios=e.medias.audio,_.each(audios,function(e){n.audios.push(e.content_url)})),void 0!==e.medias.embeded&&(embededs=e.medias.embeded,_.each(embededs,function(e){n.embededs.push(e.content)})),void 0!==e.medias.visuel&&(visuels=e.medias.visuel,_.each(visuels,function(e){n.visuels.push(e.content_url)}))}),n}function processEvents(e,t,n){for(var i=_.toArray(e),s=0;s<e.length;s++){var o=e[s];o.title=o.title.fre,o.subtitle=o.subtitle.fre,o.style=o.style.fre,o.description2=o.description2.fre,o.link1=o.link1.fre,""==o.link1&&(o.link1=!1),o.month=o.dateStart.split("-")[1],o.month_text=numberToMonth(o.month),o.day=o.dateStart.split("-")[2],o.description_short=jQuery("<p>"+o.description2+"</p>").text().split(" ").slice(0,20).join(" ")+"...",o.category=getEventTypeName(o.eventTypeId,t),o.media=getMediaFiles(o.eventId,n),o.usine_link=single_event_page+"#e="+o.eventId,o.banner="",void 0!==o.medias.visuel&&(o.banner=o.medias.visuel[0].content_url)}return i}function get_single_event(e,t){return _.find(e,function(e){return e.eventId==t})}function numberToMonth(e){return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e-1]}function hasLocalStorage(){var e=window.sessionStorage;try{return e.setItem("test","1"),e.removeItem("test"),!0}catch(e){return!1}}function initUsineEvents(e){var t=$("#events_template").html(),n=$("#events_container"),i=$("#more_events_template").html(),s=$("#more_events_container"),o=$("#event_single_template").html(),a=$("#event_single_container"),r=e.events,l=processEvents(r,e.event_types,e.plays);if($events_for_prochainement=l.slice(0,3),$more_events=l.splice(3,l.length),n.length>0){var c=_.template(t);n.html(c({events:$events_for_prochainement}))}if(s.length>0){var d=_.template(i);s.html(d({events:$more_events}))}if(window.location.hash)for(var v=window.location.hash.split("&"),u=0;u<v.length;u++){var m=v[u];if(console.log(m),-1!==m.indexOf("e=")){var g=m.split("=")[1];if(a.length>0){var f=_.template(o),h=get_single_event(r,g);a.html(f({event:h})),loadEventSlider()}}}}!function(e,t,n){e(function(){"use strict";var t=e(window),n=t.height(),i=e("header"),s=e("#social_bar"),o=e("#featured_section"),a=e("#featured_slides");o.outerHeight();hasLocalStorage()&&null!=localStorage.getItem("usine_access_token")?callEventsApi(localStorage.getItem("usine_access_token")):"undefined "!=typeof access_token_url&&getAccessToken(),setInterval(function(){a.click()},5e3),t.scroll(function(){t.scrollTop()>n?(i.addClass("visible_header"),s.addClass("visible_bar")):(i.removeClass("visible_header"),s.removeClass("visible_bar"))}),e(a).on("click",function(){var t=e("li.visible_slide",a),n=t.next("li");0==n.length&&(n=e("li",a).first()),t.removeClass("visible_slide"),n.addClass("visible_slide")});var r=Math.floor(t.width()/260);e("#partners_slider").bxSlider({minSlides:r,maxSlides:r,slideWidth:260,slideMargin:10,auto:!0,controls:!0,autoControls:!1,pager:!1}),loadEventSlider()})}(jQuery);