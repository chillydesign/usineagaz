function loadEventSlider(){$(".event_slider").bxSlider({auto:!0,controls:!0,autoHover:!0,video:!0,pager:!1,mode:"fade"})}function getAccessToken(){hasLocalStorage()&&(localStorage.removeItem("usine_access_token"),localStorage.removeItem("usine_events")),$.ajax({url:access_token_url,method:"GET",data:{}}).done(function(e){if(e.error)console.log(error.error_description);else{var t=e.access_token;hasLocalStorage()&&localStorage.setItem("usine_access_token",t),callEventsApi(t)}})}function shouldGetEventsFromStorage(){if(hasLocalStorage()){var e=localStorage.getItem("usine_events"),t=localStorage.getItem("usine_events_time");return null!=e&&((new Date).getTime()-t)/1e3/60/30<1}return!1}function callEventsApi(e){if(shouldGetEventsFromStorage()){var t=localStorage.getItem("usine_events");initUsineEvents(JSON.parse(t))}else{$.ajax({url:"https://api.intrazik.com/api/v1/programmation",method:"GET",data:{access_token:e,dateTimeDebut:"2017-05-01",dateTimeFin:"2023-12-01"}}).done(function(e){hasLocalStorage()&&(localStorage.setItem("usine_events_time",(new Date).getTime()),localStorage.setItem("usine_events",JSON.stringify(e))),initUsineEvents(e)}).fail(function(e){"invalid_grant"==e.responseJSON.error&&(console.log("invlaidgrant"),getAccessToken())})}}function getEventTypeName(e,t){var n=_.find(t,function(t){return t.eventTypeId==e});return void 0!==n&&n.eventTypeLib.fre}function getMediaFiles(e,t){var t=_.filter(t,function(t){return t.eventId==e}),n={audios:[],visuels:[],embededs:[]};return _.each(t,function(e){void 0!==e.medias.audio&&(audios=e.medias.audio,_.each(audios,function(e){n.audios.push(e.content_url)})),void 0!==e.medias.embeded&&(embededs=e.medias.embeded,_.each(embededs,function(e){n.embededs.push(e.content)})),void 0!==e.medias.visuel&&(visuels=e.medias.visuel,_.each(visuels,function(e){n.visuels.push(e.content_url)}))}),n}function processData(e,t,n){var i=e.events,a=e.event_types,o=e.plays;if(void 0!==t&&t!=={}){var s=Date.parse(t.dateTimeDebut),r=Date.parse(t.dateTimeFin);_.isNaN(r)||_.isNaN(r)||(i=_.filter(i,function(e){return Date.parse(e.dateStart)>=s&&Date.parse(e.dateStart)<=r}))}void 0!==n&&0!=n&&(i=_.filter(i,function(e){return e.title.fre.toLowerCase().indexOf(n.toLowerCase())>-1}));for(var l=_.toArray(i),c=0;c<l.length;c++){var d=l[c];d.the_title=d.title.fre,d.the_subtitle=d.subtitle.fre,d.the_style=d.style.fre,d.the_description2=d.description2.fre,d.the_link1=d.link1.fre,""==d.the_link1&&(d.the_link1=!1),d.the_month=d.dateStart.split("-")[1],d.the_month_text=numberToMonth(d.the_month),d.the_day=d.dateStart.split("-")[2],d.the_description_short=jQuery("<p>"+d.the_description2+"</p>").text().split(" ").slice(0,20).join(" ")+"...",d.the_category=getEventTypeName(d.eventTypeId,a),d.the_media=getMediaFiles(d.eventId,o),d.the_usine_link=single_event_page+"#e="+d.eventId,d.the_banner="",void 0!==d.medias.visuel&&(d.the_banner=d.medias.visuel[0].content_url)}return e.events=l,e}function get_single_event(e,t){return _.find(e,function(e){return e.eventId==t})}function displaySingleEvent(e,t,n){t.html(n({event:e})),loadEventSlider()}function displayEvents(e,t,n){var i=_.clone(e),a=$(".date_field"),o=$("#eventKeyword"),s={};a.each(function(){var e=$(this);$name=e.attr("name"),""!=e.val()&&(s[$name]=e.val())}),$search=!1,""!=o.val()&&($search=o.val());var r=processData(i,s,$search);t.html(n({events:r.events}))}function numberToMonth(e){return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e-1]}function hasLocalStorage(){var e=window.sessionStorage;try{return e.setItem("test","1"),e.removeItem("test"),!0}catch(e){return!1}}function initUsineEvents(e){var t=$("#events_template").html(),n=$("#events_container"),i=$("#more_events_template").html(),a=$("#more_events_container"),o=$("#event_single_template").html(),s=$("#event_single_container"),r=$(".date_field"),l=$("#eventKeyword"),c=processData(e);if(n.length>0){var d=_.template(t);$events_for_prochainement=c.events.slice(0,3),n.html(d({events:$events_for_prochainement}))}if(a.length>0){var v=_.template(i);displayEvents(e,a,v),r.on("change",function(t){displayEvents(e,a,v)}),l.on("keyup",function(t){displayEvents(e,a,v)})}if(window.location.hash)for(var u=window.location.hash.split("&"),h=0;h<u.length;h++){var m=u[h];if(-1!==m.indexOf("e=")){var f=m.split("=")[1];s.length>0&&displaySingleEvent(get_single_event(c.events,f),s,_.template(o))}}}function jumpToSearchEventsForm(){var e=$("#jump_to_search"),t=$("#eventSearchForm").hide();if(e.on("click",function(e){e.preventDefault();var n=$(this).attr("href"),i=n.split("#")[1];t.show(),void 0!==i&&t.length>0?$("html, body").animate({scrollTop:t.offset().top},1e3):window.location.href=n}),window.location.hash)for(var n=window.location.hash.split("&"),i=0;i<n.length;i++)-1!==n[i].indexOf("eventSearchForm")&&(t.show(),$("html, body").animate({scrollTop:t.offset().top},1e3))}!function(e,t,n){e(function(){"use strict";var t=e(window),n=(e("body"),t.height(),e("header")),i=e("#social_bar"),a=e("#featured_section"),o=e("#featured_slides");a.outerHeight();hasLocalStorage()&&null!=localStorage.getItem("usine_access_token")?callEventsApi(localStorage.getItem("usine_access_token")):"undefined "!=typeof access_token_url&&getAccessToken();var s=e("#show_nav"),r=e("header nav");s.on("click",function(e){e.preventDefault(),r.toggleClass("navigation_visible")}),jumpToSearchEventsForm(),setInterval(function(){o.click()},5e3),t.scroll(function(){t.scrollTop()>300?(n.addClass("visible_header"),i.addClass("visible_bar")):(n.removeClass("visible_header"),i.removeClass("visible_bar"))}),e(o).on("click",function(){var t=e("li.visible_slide",o),n=t.next("li");0==n.length&&(n=e("li",o).first()),t.removeClass("visible_slide"),n.addClass("visible_slide")});var l=Math.floor(t.width()/260);e("#partners_slider").bxSlider({minSlides:l,maxSlides:l,slideWidth:260,slideMargin:10,auto:!0,controls:!0,autoControls:!1,pager:!1}),loadEventSlider()})}(jQuery);