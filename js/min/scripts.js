function loadEventSlider(){$(".event_slider").bxSlider({auto:!0,controls:!0,autoHover:!0,video:!1,pager:!1,mode:"fade"})}function getAccessToken(){hasLocalStorage()&&(localStorage.removeItem("usine_access_token"),localStorage.removeItem("usine_events_list")),$.ajax({url:access_token_url,method:"GET",data:{}}).done(function(e){if(e.error)console.log(error.error_description);else{var t=e.access_token;hasLocalStorage()&&localStorage.setItem("usine_access_token",t),callEventsApi(t)}})}function shouldGetEventsFromStorage(){if(hasLocalStorage()){var e=localStorage.getItem("usine_events_list"),t=localStorage.getItem("usine_events_time"),n=moment.unix(t/1e3),i=moment().subtract(10,"minutes").isBefore(n);return null!=e&&i?(console.log("return true, should get from storage"),!0):(console.log("return false, should get from api"),!1)}return console.log("return has no local storage"),!1}function callEventsApi(e){if(shouldGetEventsFromStorage()){var t=localStorage.getItem("usine_events_list");initUsineEvents(JSON.parse(t))}else{var n=moment(),i=n.format("YYYY-MM-DD"),a=n.add(1,"y").format("YYYY-MM-DD");$.ajax({url:"https://api.intrazik.com/api/v1/programmation",method:"GET",data:{access_token:e,dateTimeDebut:i,dateTimeFin:a}}).done(function(e){hasLocalStorage()&&(localStorage.setItem("usine_events_time",(new Date).getTime()),localStorage.setItem("usine_events_list",JSON.stringify(e))),initUsineEvents(e)}).fail(function(e){"invalid_grant"==e.responseJSON.error&&(console.log("invlaidgrant"),getAccessToken())})}}function getEventTypeName(e,t){var n=_.find(t,function(t){return t.eventTypeId==e});return void 0!==n&&n.eventTypeLib.fre}function getMediaFiles(e,t){var t=_.filter(t,function(t){return t.eventId==e}),n={audios:[],visuels:[],embededs:[],artists:[]},i=["link1","link2","link3","link4","link5"];return _.each(t,function(e){var t=[];if(void 0!==e.medias.audio){var a=e.medias.audio;_.each(a,function(e){"site_web"===e.dest&&n.audios.push(e)})}if(void 0!==e.medias.embeded){var o=e.medias.embeded;_.each(o,function(e){"site_web"===e.dest&&n.embededs.push(e.content)})}if(void 0!==e.medias.visuel){var s=e.medias.visuel;_.each(s,function(e){"site_web"===e.dest&&n.visuels.push(e)})}for(var r=0;r<i.length;r++){var l=e[i[r]];""!=l&&t.push(l)}n.artists.push({artist_id:e.artisteId,name:e.title.fre,links:t})}),n}function processData(e,t,n){var i=e.events,a=e.event_types,o=e.plays;if(void 0!==t&&t!=={}){var s=Date.parse(t.dateTimeDebut);_.isNaN(s)||(i=_.filter(i,function(e){return Date.parse(e.dateStart)==s}))}void 0!==n&&0!=n&&(i=_.filter(i,function(e){return e.title.fre.toLowerCase().indexOf(n.toLowerCase())>-1||e.description2.fre.toLowerCase().indexOf(n.toLowerCase())>-1}));var r=_.toArray(i);r=_.filter(r,function(e){return 673!==e.serieId});for(var l=0;l<r.length;l++){var c=r[l];if(c.the_title=c.title.fre,c.the_subtitle=c.subtitle.fre,c.the_style=c.style.fre,c.the_description2=c.description2.fre,c.the_link1=c.link1.fre,""==c.the_link1&&(c.the_link1=!1),c.the_month=c.dateStart.split("-")[1],c.the_month_text=numberToMonth(c.the_month),c.the_day=c.dateStart.split("-")[2],c.the_description_short=$("<p>"+c.the_description2+"</p>").text().split(" ").slice(0,50).join(" ")+"...",c.the_category=getEventTypeName(c.eventTypeId,a),c.the_media=getMediaFiles(c.eventId,o),c.the_usine_link=single_event_page+"#e="+c.eventId,c.the_banner="",void 0!==c.medias.visuel){var d=_.filter(c.medias.visuel,function(e){return"Banner"===e.categoryName.fre});d.length>0&&(c.the_banner=d[0].content_url)}c.prices=_.sortBy(c.prices,"productPriceTtc").reverse()}return e.events=r,e}function get_single_event(e,t){return _.find(e,function(e){return e.eventId==t})}function displaySingleEvent(e,t,n){t.html(n({event:e})),loadEventSlider()}function displayEvents(e,t,n){var i=_.clone(e),a=$(".date_field"),o=$("#eventKeyword"),s={};a.each(function(){var e=$(this),t=e.attr("name");""!=e.val()&&(s[t]=e.val())});var r=!1;""!=o.val()&&(r=o.val());var l=processData(i,s,r);t.html(n({events:l.events}))}function numberToMonth(e){return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e-1]}function hasLocalStorage(){var e=window.sessionStorage;try{return e.setItem("test","1"),e.removeItem("test"),!0}catch(e){return!1}}function initUsineEvents(e){var t=$("#events_template").html(),n=$("#events_container"),i=$("#more_events_template").html(),a=$("#more_events_container"),o=$("#event_single_template").html(),s=$("#event_single_container"),r=$(".date_field"),l=$("#eventKeyword"),c=$("#calendar_template").html(),d=$("#calendar_container"),v=processData(e);if(n.length>0){var u=_.template(t),f=v.events.slice(0,3);n.html(u({events:f}))}if(a.length>0){var m=_.template(i);displayEvents(e,a,m),r.on("change",function(t){displayEvents(e,a,m)}),l.on("keyup",function(t){displayEvents(e,a,m)})}if(d.length>0){d.clndr({template:c,forceSixRows:!0,events:e.events,dateParameter:"dateStart",clickEvents:{click:function(e){var t=e.date._i;$("#dateTimeDebut").val(t).change(),d.removeClass("clndr_visible")}},doneRendering:function(){console.log("done"),$("#reset").on("click",function(){$("#dateTimeDebut").val("").change(),$("#calendar_container").removeClass("clndr_visible")})}});$("#dateTimeDebut").on("click",function(){d.toggleClass("clndr_visible")})}if(window.location.hash)for(var h=window.location.hash.split("&"),g=0;g<h.length;g++){var p=h[g];if(-1!==p.indexOf("e=")){var b=p.split("=")[1];if(s.length>0){var S=get_single_event(v.events,b);displaySingleEvent(S,s,_.template(o)),document.title=S.the_title}}}}function jumpToSearchEventsForm(){var e=$("#jump_to_search"),t=$("#eventSearchForm").hide();if(e.on("click",function(e){e.preventDefault();var n=$(this).attr("href"),i=n.split("#")[1];t.show(),void 0!==i&&t.length>0?$("html, body").animate({scrollTop:t.offset().top-100},1e3):window.location.href=n}),window.location.hash)for(var n=window.location.hash.split("&"),i=0;i<n.length;i++)-1!==n[i].indexOf("eventSearchForm")&&(t.show(),$("html, body").animate({scrollTop:t.offset().top-100},1e3))}import bxslider from"bxslider/src/js/jquery.bxslider.js";import clndr from"clndr";moment.locale("fr"),function(e,t,n){e(function(){"use strict";var t=e(window),n=(e("body"),t.height(),e("header")),i=e("#social_bar"),a=e("#featured_section"),o=e("#featured_slides");a.outerHeight();hasLocalStorage()&&null!=localStorage.getItem("usine_access_token")?callEventsApi(localStorage.getItem("usine_access_token")):"undefined "!=typeof access_token_url&&getAccessToken();var s=e("#show_nav"),r=e("header nav");s.on("click",function(e){e.preventDefault(),r.toggleClass("navigation_visible")}),jumpToSearchEventsForm(),setInterval(function(){o.click()},7e3),t.scroll(function(){t.scrollTop()>300?(n.addClass("visible_header"),i.addClass("visible_bar")):(n.removeClass("visible_header"),i.removeClass("visible_bar"))}),e(o).on("click",function(){var t=e("li.visible_slide",o),n=t.next("li");0==n.length&&(n=e("li",o).first()),t.removeClass("visible_slide"),n.addClass("visible_slide")});var l=Math.floor(t.width()/260);e("#partners_slider").bxSlider({minSlides:l,maxSlides:l,slideWidth:260,slideMargin:10,auto:!0,controls:!0,autoControls:!1,pager:!1,speed:1e3,pause:3e3}),loadEventSlider()})}($);