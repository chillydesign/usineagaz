function getAccessToken(){localStorage.removeItem("usine_access_token"),$.ajax({url:access_token_url,method:"GET",data:{}}).done(function(e){if(e.error)console.log(error.error_description);else{var t=e.access_token;console.log("token from api",t),localStorage.setItem("usine_access_token",t),callEventsApi(t)}})}function callEventsApi(e){for(var t=$("#events_template").html(),n=$("#events_container"),i=$("#more_events_template").html(),s=$("#more_events_container"),o="2017-05-01",r="2019-12-01",l=window.location.search.split("&"),a=0;a<l.length;a++){var c=l[a];if(-1!==c.indexOf("dateTimeDebut=")&&""!=(d=c.split("=")[1])&&(o=d),-1!==c.indexOf("dateTimeFin=")){var d=c.split("=")[1];""!=d&&(r=d)}}$.ajax({url:"https://api.intrazik.com/api/v1/programmation",method:"GET",data:{access_token:e,dateTimeDebut:o,dateTimeFin:r}}).done(function(e){var o=processEvents(e.events,e.event_types),r=_.template(t),l=_.template(i);$events_for_prochainement=o.slice(0,3),$more_events=o.splice(3,o.length),n.html(r({events:$events_for_prochainement})),s.html(l({events:$more_events}))}).fail(function(e){"invalid_grant"==e.responseJSON.error&&(console.log("invlaidgrant"),getAccessToken())})}function getEventTypeName(e,t){var n=_.filter(t,function(t){return t.eventTypeId==e});return n.length>0&&n[0].eventTypeLib.fre}function processEvents(e,t){for(var n=_.toArray(e),i=0;i<e.length;i++){var s=e[i];s.title=s.title.fre,s.subtitle=s.subtitle.fre,s.style=s.style.fre,s.description2=s.description2.fre,s.link1=s.link1.fre,""==s.link1&&(s.link1=!1),s.month=s.dateStart.split("-")[1],s.day=s.dateStart.split("-")[2],s.description_short=jQuery("<p>"+s.description2+"</p>").text().split(" ").slice(0,20).join(" ")+"...",s.category=getEventTypeName(s.eventTypeId,t),s.banner="",void 0!==s.medias.visuel&&(s.banner=s.medias.visuel[0].content_url)}return n}!function(e,t,n){e(function(){"use strict";var t=e(window),n=(t.height(),e("header")),i=e("#social_bar"),s=e("#featured_section"),o=e("#featured_slides"),r=s.outerHeight();if(null!=localStorage.getItem("usine_access_token")){var l=localStorage.getItem("usine_access_token");console.log("token from localstorage",l),callEventsApi(l)}else"undefined "!=typeof access_token_url&&getAccessToken();setInterval(function(){o.click()},5e3),t.scroll(function(){t.scrollTop()>r?(n.addClass("visible_header"),i.addClass("visible_bar")):(n.removeClass("visible_header"),i.removeClass("visible_bar"))}),e(o).on("click",function(){var t=e("li.visible_slide",o),n=t.next("li");0==n.length&&(n=e("li",o).first()),t.removeClass("visible_slide"),n.addClass("visible_slide")});var a=Math.floor(t.width()/260);e("#partners_slider").bxSlider({minSlides:a,maxSlides:a,slideWidth:260,slideMargin:10,auto:!0,controls:!0,autoControls:!1,pager:!1})})}(jQuery);