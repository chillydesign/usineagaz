function loadEventSlider(){$(".event_slider").bxSlider({auto:!0,controls:!0,autoHover:!0,video:!0,pager:!1,mode:"fade"})}function getAccessToken(){hasLocalStorage()&&(localStorage.removeItem("usine_access_token"),localStorage.removeItem("usine_events")),$.ajax({url:access_token_url,method:"GET",data:{}}).done(function(e){if(e.error)console.log(error.error_description);else{var t=e.access_token;hasLocalStorage()&&localStorage.setItem("usine_access_token",t),callEventsApi(t)}})}function shouldGetEventsFromStorage(){if(hasLocalStorage()){var e=localStorage.getItem("usine_events"),t=localStorage.getItem("usine_events_time");return null!=e&&((new Date).getTime()-t)/1e3/60/30<1}return!1}function callEventsApi(e){if(shouldGetEventsFromStorage()){var t=localStorage.getItem("usine_events");initUsineEvents(JSON.parse(t))}else{$.ajax({url:"https://api.intrazik.com/api/v1/programmation",method:"GET",data:{access_token:e,dateTimeDebut:"2017-05-01",dateTimeFin:"2023-12-01"}}).done(function(e){hasLocalStorage()&&(localStorage.setItem("usine_events_time",(new Date).getTime()),localStorage.setItem("usine_events",JSON.stringify(e))),initUsineEvents(e)}).fail(function(e){"invalid_grant"==e.responseJSON.error&&(console.log("invlaidgrant"),getAccessToken())})}}function getEventTypeName(e,t){var n=_.find(t,function(t){return t.eventTypeId==e});return void 0!==n&&n.eventTypeLib.fre}function getMediaFiles(e,t){var t=_.filter(t,function(t){return t.eventId==e}),n={audios:[],visuels:[],embededs:[],artists:[]},a=["link1","link2","link3","link4","link5"];return _.each(t,function(e){var t=[];void 0!==e.medias.audio&&(audios=e.medias.audio,_.each(audios,function(e){n.audios.push(e)})),void 0!==e.medias.embeded&&(embededs=e.medias.embeded,_.each(embededs,function(e){n.embededs.push(e.content)})),void 0!==e.medias.visuel&&(visuels=e.medias.visuel,_.each(visuels,function(e){n.visuels.push(e)}));for(var i=0;i<a.length;i++){var s=e[a[i]];""!=s&&t.push(s)}n.artists.push({artist_id:e.artisteId,name:e.title.fre,links:t})}),n}function processData(e,t,n){var a=e.events,i=e.event_types,s=e.plays;if(void 0!==t&&t!=={}){var r=Date.parse(t.dateTimeDebut);_.isNaN(r)||(a=_.filter(a,function(e){return Date.parse(e.dateStart)==r}))}void 0!==n&&0!=n&&(a=_.filter(a,function(e){return e.title.fre.toLowerCase().indexOf(n.toLowerCase())>-1||e.description2.fre.toLowerCase().indexOf(n.toLowerCase())>-1}));for(var o=_.toArray(a),l=0;l<o.length;l++){var d=o[l];d.the_title=d.title.fre,d.the_subtitle=d.subtitle.fre,d.the_style=d.style.fre,d.the_description2=d.description2.fre,d.the_link1=d.link1.fre,""==d.the_link1&&(d.the_link1=!1),d.the_month=d.dateStart.split("-")[1],d.the_month_text=numberToMonth(d.the_month),d.the_day=d.dateStart.split("-")[2],d.the_description_short=jQuery("<p>"+d.the_description2+"</p>").text().split(" ").slice(0,50).join(" ")+"...",d.the_category=getEventTypeName(d.eventTypeId,i),d.the_media=getMediaFiles(d.eventId,s),d.the_usine_link=single_event_page+"#e="+d.eventId,d.the_banner="",void 0!==d.medias.visuel&&(d.the_banner=d.medias.visuel[0].content_url)}return e.events=o,e}function get_single_event(e,t){return _.find(e,function(e){return e.eventId==t})}function displaySingleEvent(e,t,n){t.html(n({event:e})),loadEventSlider()}function displayEvents(e,t,n){var a=_.clone(e),i=$(".date_field"),s=$("#eventKeyword"),r={};i.each(function(){var e=$(this);$name=e.attr("name"),""!=e.val()&&(r[$name]=e.val())}),$search=!1,""!=s.val()&&($search=s.val());var o=processData(a,r,$search);t.html(n({events:o.events}))}function numberToMonth(e){return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e-1]}function hasLocalStorage(){var e=window.sessionStorage;try{return e.setItem("test","1"),e.removeItem("test"),!0}catch(e){return!1}}function initUsineEvents(e){var t=$("#events_template").html(),n=$("#events_container"),a=$("#more_events_template").html(),i=$("#more_events_container"),s=$("#event_single_template").html(),r=$("#event_single_container"),o=$(".date_field"),l=$("#eventKeyword"),d=$("#calendar_template").html(),c=$("#calendar_container"),v=processData(e);if(n.length>0){var u=_.template(t);$events_for_prochainement=v.events.slice(0,3),n.html(u({events:$events_for_prochainement}))}if(i.length>0){var m=_.template(a);displayEvents(e,i,m),o.on("change",function(t){displayEvents(e,i,m)}),l.on("keyup",function(t){displayEvents(e,i,m)})}if(c.length>0){c.clndr({template:d,forceSixRows:!0,events:e.events,dateParameter:"dateStart",clickEvents:{click:function(e){var t=e.date._i;$("#dateTimeDebut").val(t).change(),c.removeClass("clndr_visible")}}});$("#dateTimeDebut").on("click",function(){c.toggleClass("clndr_visible")})}if(window.location.hash)for(var h=window.location.hash.split("&"),f=0;f<h.length;f++){var p=h[f];if(-1!==p.indexOf("e=")){var g=p.split("=")[1];if(r.length>0){var S=get_single_event(v.events,g);displaySingleEvent(S,r,_.template(s)),document.title=S.the_title}}}}function jumpToSearchEventsForm(){var e=$("#jump_to_search"),t=$("#eventSearchForm").hide();if(e.on("click",function(e){e.preventDefault();var n=$(this).attr("href"),a=n.split("#")[1];t.show(),void 0!==a&&t.length>0?$("html, body").animate({scrollTop:t.offset().top-100},1e3):window.location.href=n}),window.location.hash)for(var n=window.location.hash.split("&"),a=0;a<n.length;a++)-1!==n[a].indexOf("eventSearchForm")&&(t.show(),$("html, body").animate({scrollTop:t.offset().top-100},1e3))}function resetCalendar(){$("#dateTimeDebut").val("").change(),$("#calendar_container").removeClass("clndr_visible")}function momentInFrench(){moment.locale("fr",{months:"janvier_février_mars_avril_mai_juin_juillet_août_septembre_octobre_novembre_décembre".split("_"),monthsShort:"janv._févr._mars_avr._mai_juin_juil._août_sept._oct._nov._déc.".split("_"),monthsParseExact:!0,weekdays:"dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"Di_Lu_Ma_Me_Je_Ve_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Aujourd’hui à] LT",nextDay:"[Demain à] LT",nextWeek:"dddd [à] LT",lastDay:"[Hier à] LT",lastWeek:"dddd [dernier à] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",M:"un mois",MM:"%d mois",y:"un an",yy:"%d ans"},dayOfMonthOrdinalParse:/\d{1,2}(er|e)/,ordinal:function(e){return e+(1===e?"er":"e")},meridiemParse:/PD|MD/,isPM:function(e){return"M"===e.charAt(0)},meridiem:function(e,t,n){return e<12?"PD":"MD"},week:{dow:1,doy:4}})}!function(e,t,n){e(function(){"use strict";var t=e(window),n=(e("body"),t.height(),e("header")),a=e("#social_bar"),i=e("#featured_section"),s=e("#featured_slides");i.outerHeight();momentInFrench(),hasLocalStorage()&&null!=localStorage.getItem("usine_access_token")?callEventsApi(localStorage.getItem("usine_access_token")):"undefined "!=typeof access_token_url&&getAccessToken();var r=e("#show_nav"),o=e("header nav");r.on("click",function(e){e.preventDefault(),o.toggleClass("navigation_visible")}),jumpToSearchEventsForm(),setInterval(function(){s.click()},5e3),t.scroll(function(){t.scrollTop()>300?(n.addClass("visible_header"),a.addClass("visible_bar")):(n.removeClass("visible_header"),a.removeClass("visible_bar"))}),e(s).on("click",function(){var t=e("li.visible_slide",s),n=t.next("li");0==n.length&&(n=e("li",s).first()),t.removeClass("visible_slide"),n.addClass("visible_slide")});var l=Math.floor(t.width()/260);e("#partners_slider").bxSlider({minSlides:l,maxSlides:l,slideWidth:260,slideMargin:10,auto:!0,controls:!0,autoControls:!1,pager:!1}),loadEventSlider()})}(jQuery);